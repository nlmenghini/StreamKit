<html>

<head>
	<script src="https://cdn.jsdelivr.net/npm/numeral@2.0.6/numeral.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
	<link rel="stylesheet" href="resources/css/streaming-overlay-CAM-frame.css" />
	<script src="config.js"></script>
</head>

<body>
	<div id="app">
		<div id="percentage" class="progress"
			v-bind:data-percentage="Math.floor((entity.sumDonations / entity.fundraisingGoal) * 100)">
			<span class="progress-left">
				<span class="progress-bar"></span>
			</span>
			<span class="progress-right">
				<span class="progress-bar"></span>
			</span>
		</div>
		<div class="inner-circle"></div>
	</div>
</body>
<script>
	Vue.filter(
		'formatMoney',
		(value) => {
			return numeral(value).format('$0,0.00');
		}
	);

	var v = new Vue({
		data: {
			count: 0,
			donation: null,
			donations: [],
			entity: {
				etag: '',
				lastDonation: new Date().toISOString()
			}
		},
		el: '#app',
		methods: {
			refreshDonations() {
				var ld = new Date(this.entity.lastDonation);

				axios.get(window.config.api + window.config.resource + '/' + window.config.resourceID + '/donations' + (window.config.api.indexOf('?') >= 0 ? '&' : '?') + 'where=' + encodeURIComponent('createdDateUTC > ' + ld.toISOString()) + '&orderBy=' + encodeURIComponent('createdDateUTC ASC'))
					.then((response) => {
						response.data.forEach((dx) => {
							var createdDate = new Date(dx.createdDateUTC);

							if (createdDate > ld) {
								this.donations.push(dx);
								this.entity.lastDonation = dx.createdDateUTC;
							}
						});
					});
			},
			refreshEntity() {
				axios.get(window.config.api + window.config.resource + '/' + window.config.resourceID, { headers: { 'if-none-match': this.entity.etag } })
					.then((response) => {
						// success
						var e = Object.assign({}, this.entity, response.data);
						e.etag = response.headers.etag;

						this.entity = e;

						if (window.config.streamingThermometer.showDonations) {
							this.refreshDonations();
						}
					})
					.catch((error) => { });
			}
		}
	});

	setInterval(
		() => {
			v.refreshEntity();
		},
		15000
	);

	if (window.config.streamingThermometer.showDonations) {
		setInterval(
			() => {
				if (v.donations.length) {
					v.donation = v.donations.shift();
					setTimeout(
						() => { v.donation = null; },
						5000
					);
				}
			},
			7000
		);
	}

	v.refreshEntity();

</script>

</html>